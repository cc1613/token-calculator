<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>访客统计</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container { margin: 0 auto; }
        h1 { margin-bottom: 20px; color: #333; }
        .stats-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            gap: 40px;
        }
        .stat-item { text-align: center; }
        .stat-num { font-size: 32px; font-weight: bold; }
        .stat-label { font-size: 14px; opacity: 0.8; }
        .config {
            background: white;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .config button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .tab.active {
            background: #667eea;
            color: white;
        }
        .table-wrap {
            overflow-x: auto;
            background: white;
            border-radius: 8px;
        }
        table {
            width: 100%;
            min-width: 2000px;
            border-collapse: collapse;
            font-size: 12px;
        }
        th, td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
            white-space: nowrap;
        }
        th { background: #f8f9fa; font-weight: 600; position: sticky; top: 0; }
        tr:hover { background: #f8f9fa; }
        .empty { text-align: center; padding: 40px; color: #999; }
    </style>
</head>
<body>
    <div class="container">
        <h1>访客统计</h1>
        
        <div class="config">
            <button onclick="loadStats()">刷新数据</button>
        </div>
        
        <div class="stats-header">
            <div class="stat-item">
                <div class="stat-num" id="totalCount">-</div>
                <div class="stat-label">总访问量</div>
            </div>
            <div class="stat-item">
                <div class="stat-num" id="todayCount">-</div>
                <div class="stat-label">今日访问</div>
            </div>
            <div class="stat-item">
                <div class="stat-num" id="uniqueIps">-</div>
                <div class="stat-label">独立IP</div>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('all')">全部访问</button>
            <button class="tab" onclick="showTab('users')">独立用户</button>
        </div>
        
        <div id="allTab" class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>时间</th>
                        <th>用户ID</th>
                        <th>IP</th>
                        <th>国家</th>
                        <th>城市</th>
                        <th>类型</th>
                        <th>系统</th>
                        <th>设备</th>
                        <th>浏览器</th>
                        <th>屏幕</th>
                        <th>CPU</th>
                        <th>内存</th>
                    </tr>
                </thead>
                <tbody id="visitorList">
                    <tr><td colspan="12" class="empty">加载中...</td></tr>
                </tbody>
            </table>
        </div>
        
        <div id="usersTab" class="table-wrap" style="display:none;">
            <table>
                <thead>
                    <tr>
                        <th>用户ID</th>
                        <th>访问次数</th>
                        <th>首次访问</th>
                        <th>最后访问</th>
                        <th>IP</th>
                        <th>国家</th>
                        <th>类型</th>
                        <th>系统</th>
                        <th>设备</th>
                        <th>浏览器</th>
                        <th>屏幕</th>
                    </tr>
                </thead>
                <tbody id="userList">
                    <tr><td colspan="11" class="empty">加载中...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let allVisitors = [];
        
        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[onclick="showTab('${tab}')"]`).classList.add('active');
            document.getElementById('allTab').style.display = tab === 'all' ? 'block' : 'none';
            document.getElementById('usersTab').style.display = tab === 'users' ? 'block' : 'none';
        }
        
        async function loadStats() {
            document.getElementById('visitorList').innerHTML = '<tr><td colspan="12" class="empty">加载中...</td></tr>';
            document.getElementById('userList').innerHTML = '<tr><td colspan="11" class="empty">加载中...</td></tr>';
            
            try {
                const res = await fetch('/api/stats');
                const data = await res.json();
                
                document.getElementById('totalCount').textContent = data.count || 0;
                
                allVisitors = data.visitors || [];
                const today = new Date().toDateString();
                const todayVisits = allVisitors.filter(v => new Date(v.timestamp).toDateString() === today);
                const uniqueUsers = new Set(allVisitors.map(v => v.fingerprint).filter(f => f)).size;
                
                document.getElementById('todayCount').textContent = todayVisits.length;
                document.getElementById('uniqueIps').textContent = uniqueUsers || new Set(allVisitors.map(v => v.ip)).size;
                
                if (allVisitors.length === 0) {
                    document.getElementById('visitorList').innerHTML = '<tr><td colspan="12" class="empty">暂无数据</td></tr>';
                    document.getElementById('userList').innerHTML = '<tr><td colspan="11" class="empty">暂无数据</td></tr>';
                    return;
                }
                
                allVisitors.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // 全部访问列表
                document.getElementById('visitorList').innerHTML = allVisitors.map(v => `<tr>
                    <td>${new Date(v.timestamp).toLocaleString('zh-CN')}</td>
                    <td>${v.fingerprint || '-'}</td>
                    <td>${v.ip || '-'}</td>
                    <td>${v.country || '-'}</td>
                    <td>${v.city || '-'}</td>
                    <td>${v.deviceType || '-'}</td>
                    <td>${v.os || '-'} ${v.osVer || ''}</td>
                    <td title="${v.device || ''}">${v.device || '-'}</td>
                    <td>${v.browser || '-'} ${v.browserVer || ''}</td>
                    <td>${v.screen || '-'}</td>
                    <td>${v.cores || '-'}</td>
                    <td>${v.memory ? v.memory + 'G' : '-'}</td>
                </tr>`).join('');
                
                // 按用户分组
                const userMap = {};
                allVisitors.forEach(v => {
                    const id = v.fingerprint || v.ip;
                    if (!userMap[id]) {
                        userMap[id] = { ...v, visits: [], count: 0 };
                    }
                    userMap[id].visits.push(v.timestamp);
                    userMap[id].count++;
                });
                
                const users = Object.values(userMap).sort((a, b) => b.count - a.count);
                
                document.getElementById('userList').innerHTML = users.map(u => {
                    const times = u.visits.map(t => new Date(t)).sort((a,b) => a-b);
                    return `<tr>
                        <td>${u.fingerprint || u.ip}</td>
                        <td><strong>${u.count}</strong></td>
                        <td>${times[0].toLocaleString('zh-CN')}</td>
                        <td>${times[times.length-1].toLocaleString('zh-CN')}</td>
                        <td>${u.ip || '-'}</td>
                        <td>${u.country || '-'}</td>
                        <td>${u.deviceType || '-'}</td>
                        <td>${u.os || '-'} ${u.osVer || ''}</td>
                        <td title="${u.device || ''}">${u.device || '-'}</td>
                        <td>${u.browser || '-'} ${u.browserVer || ''}</td>
                        <td>${u.screen || '-'}</td>
                    </tr>`;
                }).join('');
                
            } catch (e) {
                document.getElementById('visitorList').innerHTML = `<tr><td colspan="12" class="empty">加载失败: ${e.message}</td></tr>`;
            }
        }
        
        loadStats();
    </script>
</body>
</html>
