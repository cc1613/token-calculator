<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>访客统计</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { margin-bottom: 20px; color: #333; }
        .stats-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            gap: 40px;
            flex-wrap: wrap;
        }
        .stat-item { text-align: center; }
        .stat-num { font-size: 32px; font-weight: bold; }
        .stat-label { font-size: 14px; opacity: 0.8; }
        .config {
            background: white;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .config button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
        }
        .card {
            background: white;
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .card-header {
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .card-header:hover { background: #f8f9fa; }
        .card-main { display: flex; gap: 20px; flex-wrap: wrap; align-items: center; }
        .card-time { color: #666; font-size: 13px; min-width: 150px; }
        .card-ip { font-weight: 600; min-width: 120px; }
        .card-loc { color: #667eea; min-width: 150px; }
        .card-device { color: #888; font-size: 12px; }
        .card-details {
            display: none;
            padding: 16px;
            background: #f8f9fa;
            font-size: 13px;
        }
        .card.open .card-details { display: block; }
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }
        .detail-item { padding: 8px; background: white; border-radius: 4px; }
        .detail-label { font-size: 11px; color: #999; margin-bottom: 2px; }
        .detail-value { font-weight: 500; word-break: break-all; }
        .empty { text-align: center; padding: 40px; color: #999; background: white; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>访客统计</h1>
        
        <div class="config">
            <button onclick="loadStats()">刷新数据</button>
        </div>
        
        <div class="stats-header">
            <div class="stat-item">
                <div class="stat-num" id="totalCount">-</div>
                <div class="stat-label">总访问量</div>
            </div>
            <div class="stat-item">
                <div class="stat-num" id="todayCount">-</div>
                <div class="stat-label">今日访问</div>
            </div>
            <div class="stat-item">
                <div class="stat-num" id="uniqueIps">-</div>
                <div class="stat-label">独立IP</div>
            </div>
        </div>
        
        <div id="visitorList"><div class="empty">加载中...</div></div>
    </div>

    <script>
        async function loadStats() {
            document.getElementById('visitorList').innerHTML = '<div class="empty">加载中...</div>';
            
            try {
                const res = await fetch('/api/stats');
                const data = await res.json();
                
                document.getElementById('totalCount').textContent = data.count || 0;
                
                const visitors = data.visitors || [];
                const today = new Date().toDateString();
                const todayVisits = visitors.filter(v => new Date(v.timestamp).toDateString() === today);
                const uniqueIps = new Set(visitors.map(v => v.ip)).size;
                
                document.getElementById('todayCount').textContent = todayVisits.length;
                document.getElementById('uniqueIps').textContent = uniqueIps;
                
                if (visitors.length === 0) {
                    document.getElementById('visitorList').innerHTML = '<div class="empty">暂无数据</div>';
                    return;
                }
                
                visitors.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                document.getElementById('visitorList').innerHTML = visitors.map(v => {
                    const bat = v.battery ? JSON.parse(v.battery) : {};
                    return `
                    <div class="card" onclick="this.classList.toggle('open')">
                        <div class="card-header">
                            <div class="card-main">
                                <span class="card-time">${new Date(v.timestamp).toLocaleString('zh-CN')}</span>
                                <span class="card-ip">${v.ip || '-'}</span>
                                <span class="card-loc">${v.country || ''} ${v.city || ''} ${v.region || ''}</span>
                                <span class="card-device">${v.screen || ''} | ${v.platform || ''}</span>
                            </div>
                            <span>▼</span>
                        </div>
                        <div class="card-details">
                            <div class="detail-grid">
                                <div class="detail-item"><div class="detail-label">ASN</div><div class="detail-value">${v.asn || '-'}</div></div>
                                <div class="detail-item"><div class="detail-label">屏幕</div><div class="detail-value">${v.screen || '-'} (${v.colorDepth || 0}bit, ${v.pixelRatio || 1}x)</div></div>
                                <div class="detail-item"><div class="detail-label">窗口</div><div class="detail-value">${v.viewport || '-'}</div></div>
                                <div class="detail-item"><div class="detail-label">语言</div><div class="detail-value">${v.languages || v.language || '-'}</div></div>
                                <div class="detail-item"><div class="detail-label">时区</div><div class="detail-value">${v.timezone || '-'}</div></div>
                                <div class="detail-item"><div class="detail-label">CPU核心</div><div class="detail-value">${v.cores || '-'}</div></div>
                                <div class="detail-item"><div class="detail-label">内存</div><div class="detail-value">${v.memory ? v.memory + 'GB' : '-'}</div></div>
                                <div class="detail-item"><div class="detail-label">网络</div><div class="detail-value">${v.connection || '-'} (${v.downlink || 0}Mbps, ${v.rtt || 0}ms)</div></div>
                                <div class="detail-item"><div class="detail-label">触控点</div><div class="detail-value">${v.touch || 0}</div></div>
                                <div class="detail-item"><div class="detail-label">Cookie</div><div class="detail-value">${v.cookieEnabled ? '是' : '否'}</div></div>
                                <div class="detail-item"><div class="detail-label">DNT</div><div class="detail-value">${v.doNotTrack || '-'}</div></div>
                                <div class="detail-item"><div class="detail-label">自动化</div><div class="detail-value">${v.webdriver ? '是' : '否'}</div></div>
                                <div class="detail-item"><div class="detail-label">插件数</div><div class="detail-value">${v.plugins || 0}</div></div>
                                <div class="detail-item"><div class="detail-label">在线</div><div class="detail-value">${v.online ? '是' : '否'}</div></div>
                                <div class="detail-item"><div class="detail-label">电池</div><div class="detail-value">${bat.level !== undefined ? bat.level + '%' + (bat.charging ? ' 充电中' : '') : '-'}</div></div>
                                <div class="detail-item"><div class="detail-label">历史长度</div><div class="detail-value">${v.historyLen || 0}</div></div>
                                <div class="detail-item"><div class="detail-label">WebGL</div><div class="detail-value">${v.webgl || '-'}</div></div>
                                <div class="detail-item"><div class="detail-label">来源</div><div class="detail-value">${v.referrer || '-'}</div></div>
                            </div>
                            <div class="detail-item" style="margin-top:12px"><div class="detail-label">UA</div><div class="detail-value">${v.ua || '-'}</div></div>
                        </div>
                    </div>
                `}).join('');
            } catch (e) {
                document.getElementById('visitorList').innerHTML = `<div class="empty">加载失败: ${e.message}</div>`;
            }
        }
        
        loadStats();
    </script>
</body>
</html>
