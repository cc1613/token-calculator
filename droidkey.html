<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factory Key ç®¡ç†</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f0f0f;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 900px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        h1 { font-size: 20px; font-weight: 500; }
        .back { color: #667eea; text-decoration: none; font-size: 14px; }
        
        .section { background: #1a1a1a; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .section-title { font-size: 14px; color: #888; margin-bottom: 12px; }
        
        /* ç™»å½•æ ·å¼ */
        .auth-container { max-width: 400px; margin: 100px auto; }
        .auth-box { background: #1a1a1a; border-radius: 12px; padding: 30px; }
        .auth-box h2 { text-align: center; margin-bottom: 24px; font-size: 22px; }
        .auth-tabs { display: flex; margin-bottom: 20px; }
        .auth-tab { flex: 1; padding: 10px; background: #2a2a2a; border: none; color: #888; cursor: pointer; font-size: 14px; }
        .auth-tab:first-child { border-radius: 6px 0 0 6px; }
        .auth-tab:last-child { border-radius: 0 6px 6px 0; }
        .auth-tab.active { background: #667eea; color: white; }
        .auth-input { width: 100%; padding: 12px 14px; background: #0a0a0a; border: 1px solid #333; border-radius: 8px; color: #fff; font-size: 14px; margin-bottom: 12px; }
        .auth-input:focus { outline: none; border-color: #667eea; }
        .auth-btn { width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; margin-top: 8px; }
        .auth-btn:hover { background: #5a6fd6; }
        .auth-error { color: #f87171; font-size: 13px; margin-top: 10px; text-align: center; }
        .user-info { display: flex; align-items: center; gap: 12px; font-size: 14px; }
        .user-info span { color: #667eea; }
        .logout-btn { padding: 6px 12px; background: #2a2a2a; border: none; color: #888; border-radius: 6px; cursor: pointer; font-size: 12px; }
        .logout-btn:hover { background: #333; color: #fff; }
        
        .os-detect { color: #888; font-size: 14px; margin-bottom: 8px; }
        .os-detect span { color: #667eea; }
        .current-key { font-family: monospace; font-size: 16px; color: #fff; }
        
        /* æŠ˜å é¢æ¿ */
        .collapsible { cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .collapsible:after { content: 'â–¼'; font-size: 10px; color: #666; transition: transform 0.3s; }
        .collapsible.collapsed:after { transform: rotate(-90deg); }
        .collapse-content { overflow: hidden; transition: max-height 0.3s ease; }
        .collapse-content.collapsed { max-height: 0 !important; }
        
        /* å¤‡æ³¨æ ·å¼ */
        .key-note { font-size: 12px; color: #60a5fa; margin-top: 6px; padding: 4px 8px; background: #1e3a5f; border-radius: 4px; display: inline-block; }
        .btn-note { background: #2d3748; color: #a0aec0; }
        
        .tabs { display: flex; gap: 0; margin: 16px 0 12px; }
        .tab { padding: 8px 16px; background: #2a2a2a; border: none; color: #888; cursor: pointer; font-size: 13px; }
        .tab:first-child { border-radius: 6px 0 0 6px; }
        .tab:last-child { border-radius: 0 6px 6px 0; }
        .tab.active { background: #667eea; color: white; }
        
        .cmd-block { margin-bottom: 12px; }
        .cmd-label { font-size: 12px; color: #666; margin-bottom: 6px; }
        .cmd-box { background: #0a0a0a; border-radius: 8px; padding: 12px 16px; font-family: monospace; font-size: 13px; display: flex; justify-content: space-between; align-items: center; }
        .cmd-box code { color: #4ade80; word-break: break-all; }
        .copy-btn { background: #333; border: none; color: #888; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap; margin-left: 12px; }
        .copy-btn:hover { background: #444; color: #fff; }
        
        .add-form { display: flex; gap: 10px; flex-wrap: wrap; }
        .add-form input { flex: 1; min-width: 200px; padding: 10px 14px; background: #0a0a0a; border: 1px solid #333; border-radius: 8px; color: #fff; font-size: 14px; }
        .add-form input:focus { outline: none; border-color: #667eea; }
        .add-form button { padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; }
        .add-form button:disabled { background: #444; cursor: not-allowed; }
        
        .stats { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
        .stat { background: #1a1a1a; border-radius: 8px; padding: 12px 20px; text-align: center; min-width: 100px; }
        .stat-value { font-size: 24px; font-weight: 600; }
        .stat-value.normal { color: #4ade80; }
        .stat-value.low { color: #fbbf24; }
        .stat-value.error { color: #f87171; }
        .stat-label { font-size: 12px; color: #666; margin-top: 4px; }
        
        /* ç€‘å¸ƒæµç½‘æ ¼å¸ƒå±€ */
        .key-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; }
        .key-card { background: #1a1a1a; border: 2px solid transparent; border-radius: 10px; padding: 14px 18px; cursor: grab; transition: all 0.2s; }
        .key-card:hover { border-color: #333; }
        .key-card.selected { border-color: #667eea; background: #1e1e2e; }
        .key-card.error { border-color: #f87171; }
        .key-card.low { border-color: #fbbf24; }
        .key-card.dragging { opacity: 0.5; cursor: grabbing; }
        .key-card.drag-over { border-color: #667eea; border-style: dashed; }
        .key-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .key-value { font-family: monospace; font-size: 13px; color: #fff; word-break: break-all; flex: 1; }
        .key-status { font-size: 11px; padding: 2px 8px; border-radius: 4px; margin-left: 8px; white-space: nowrap; }
        .key-status.normal { background: #166534; color: #4ade80; }
        .key-status.low { background: #854d0e; color: #fbbf24; }
        .key-status.error { background: #991b1b; color: #f87171; }
        .key-status.pending { background: #1e3a5f; color: #60a5fa; }
        .key-info { display: flex; flex-direction: column; gap: 4px; font-size: 12px; color: #888; }
        .key-actions { display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap; }
        .key-actions button { padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .btn-delete { background: #7f1d1d; color: #f87171; }
        .btn-refresh { background: #1e3a5f; color: #60a5fa; }
        .btn-copy { background: #166534; color: #4ade80; }
        
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 10px; }
        .toolbar-left { font-size: 14px; color: #888; }
        .toolbar-right { display: flex; gap: 10px; align-items: center; }
        .toolbar button { padding: 6px 14px; background: #2a2a2a; border: none; color: #888; border-radius: 6px; cursor: pointer; font-size: 13px; }
        .toolbar button:hover { background: #333; color: #fff; }
        .toolbar button.danger:hover { background: #7f1d1d; color: #f87171; }
        
        .empty { text-align: center; padding: 40px; color: #666; }
        .auto-refresh { display: flex; align-items: center; gap: 8px; font-size: 13px; }
        .auto-refresh input { accent-color: #667eea; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <!-- ç™»å½•ç•Œé¢ -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <h2>ğŸ”‘ Factory Key ç®¡ç†</h2>
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">ç™»å½•</button>
                <button class="auth-tab" onclick="switchAuthTab('register')">æ³¨å†Œ</button>
            </div>
            <input type="text" class="auth-input" id="authUsername" placeholder="ç”¨æˆ·å">
            <input type="password" class="auth-input" id="authPassword" placeholder="å¯†ç ">
            <button class="auth-btn" id="authBtn" onclick="handleAuth()">ç™»å½•</button>
            <div class="auth-error" id="authError"></div>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div class="container hidden" id="mainContainer">
        <div class="header">
            <h1>ğŸ”‘ Factory Key ç®¡ç†</h1>
            <div class="user-info">
                <span id="currentUser"></span>
                <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
                <a href="index.html" class="back">â† è¿”å›å·¥å…·ç®±</a>
            </div>
        </div>
        
        <div class="section">
            <div class="os-detect">æ£€æµ‹åˆ°: <span id="osName">-</span></div>
            <div class="current-key">å½“å‰: <code id="currentKey">-</code></div>
            
            <h3 class="collapsible collapsed" style="font-size:14px; margin:16px 0 8px;" onclick="toggleEnvSection()">
                <span>ç¯å¢ƒå˜é‡è®¾ç½®æŒ‡ä»¤</span>
            </h3>
            <div class="collapse-content collapsed" id="envSection" style="max-height: 500px;">
            <div class="tabs">
                <button class="tab active" onclick="showOS('windows')">Windows</button>
                <button class="tab" onclick="showOS('linux')">Linux</button>
                <button class="tab" onclick="showOS('mac')">macOS</button>
            </div>
            
            <div id="cmdWindows">
                <div class="cmd-block">
                    <div class="cmd-label">ä¸´æ—¶è®¾ç½® (å½“å‰ç»ˆç«¯æœ‰æ•ˆ)</div>
                    <div class="cmd-box"><code id="cmdWinTemp">set FACTORY_API_KEY=YOUR_API_KEY</code><button class="copy-btn" onclick="copyCmd('cmdWinTemp')">å¤åˆ¶</button></div>
                </div>
                <div class="cmd-block">
                    <div class="cmd-label">æ°¸ä¹…è®¾ç½® (éœ€ç®¡ç†å‘˜æƒé™)</div>
                    <div class="cmd-box"><code id="cmdWinPerm">setx FACTORY_API_KEY "YOUR_API_KEY"</code><button class="copy-btn" onclick="copyCmd('cmdWinPerm')">å¤åˆ¶</button></div>
                </div>
            </div>
            <div id="cmdLinux" style="display:none;">
                <div class="cmd-block">
                    <div class="cmd-label">ä¸´æ—¶è®¾ç½®</div>
                    <div class="cmd-box"><code id="cmdLinuxTemp">export FACTORY_API_KEY="YOUR_API_KEY"</code><button class="copy-btn" onclick="copyCmd('cmdLinuxTemp')">å¤åˆ¶</button></div>
                </div>
                <div class="cmd-block">
                    <div class="cmd-label">Bash æ°¸ä¹…è®¾ç½® (~/.bashrc)</div>
                    <div class="cmd-box"><code id="cmdLinuxBash">echo 'export FACTORY_API_KEY="YOUR_API_KEY"' >> ~/.bashrc && source ~/.bashrc</code><button class="copy-btn" onclick="copyCmd('cmdLinuxBash')">å¤åˆ¶</button></div>
                </div>
            </div>
            <div id="cmdMac" style="display:none;">
                <div class="cmd-block">
                    <div class="cmd-label">ä¸´æ—¶è®¾ç½®</div>
                    <div class="cmd-box"><code id="cmdMacTemp">export FACTORY_API_KEY="YOUR_API_KEY"</code><button class="copy-btn" onclick="copyCmd('cmdMacTemp')">å¤åˆ¶</button></div>
                </div>
                <div class="cmd-block">
                    <div class="cmd-label">Zsh æ°¸ä¹…è®¾ç½® (~/.zshrc)</div>
                    <div class="cmd-box"><code id="cmdMacZsh">echo 'export FACTORY_API_KEY="YOUR_API_KEY"' >> ~/.zshrc && source ~/.zshrc</code><button class="copy-btn" onclick="copyCmd('cmdMacZsh')">å¤åˆ¶</button></div>
                </div>
            </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">æ·»åŠ å¯†é’¥</div>
            <div class="add-form">
                <input type="text" id="keyValue" placeholder="è¾“å…¥ Factory API Key">
                <button onclick="addKey()" id="addKeyBtn">æ·»åŠ </button>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat"><div class="stat-value" id="totalKeys">0</div><div class="stat-label">æ€»è®¡</div></div>
            <div class="stat"><div class="stat-value normal" id="normalKeys">0</div><div class="stat-label">æ­£å¸¸</div></div>
            <div class="stat"><div class="stat-value low" id="lowKeys">0</div><div class="stat-label">ä½ä½™é¢</div></div>
            <div class="stat"><div class="stat-value error" id="errorKeys">0</div><div class="stat-label">å¼‚å¸¸</div></div>
        </div>
        
        <div class="toolbar">
            <div class="toolbar-left">å¯†é’¥åˆ—è¡¨ <span style="color:#666">ç‚¹å‡»å¡ç‰‡é€‰ä¸­å¯†é’¥ï¼Œä¸Šæ–¹å‘½ä»¤è‡ªåŠ¨æ›´æ–°</span></div>
            <div class="toolbar-right">
                <label class="auto-refresh"><input type="checkbox" id="autoRefresh"> è‡ªåŠ¨åˆ·æ–° (60ç§’)</label>
                <button onclick="refreshAll()">åˆ·æ–°å…¨éƒ¨</button>
                <button onclick="clearAll()" class="danger">æ¸…ç©ºå…¨éƒ¨</button>
            </div>
        </div>
        
        <div class="key-list" id="keyList">
            <div class="empty">æš‚æ— å¯†é’¥ï¼Œè¯·æ·»åŠ ä½ çš„ç¬¬ä¸€ä¸ª API Key</div>
        </div>
    </div>

    <script>
        let keys = [];
        let selectedIndex = -1;
        let currentUser = null;
        let authToken = null;
        let authMode = 'login';
        
        // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
        const savedAuth = localStorage.getItem('factoryAuth');
        if (savedAuth) {
            const auth = JSON.parse(savedAuth);
            authToken = auth.token;
            currentUser = auth.username;
            showMainUI();
            loadKeys();
        }
        
        function switchAuthTab(mode) {
            authMode = mode;
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.auth-tab:${mode === 'login' ? 'first' : 'last'}-child`).classList.add('active');
            document.getElementById('authBtn').textContent = mode === 'login' ? 'ç™»å½•' : 'æ³¨å†Œ';
            document.getElementById('authError').textContent = '';
        }
        
        async function handleAuth() {
            const username = document.getElementById('authUsername').value.trim();
            const password = document.getElementById('authPassword').value;
            const errorEl = document.getElementById('authError');
            
            if (!username || !password) {
                errorEl.textContent = 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ';
                return;
            }
            
            try {
                const response = await fetch('/api/user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: authMode, username, password })
                });
                const data = await response.json();
                
                if (data.error) {
                    errorEl.textContent = data.error;
                    return;
                }
                
                authToken = data.token;
                currentUser = data.username;
                localStorage.setItem('factoryAuth', JSON.stringify({ token: authToken, username: currentUser }));
                showMainUI();
                loadKeys();
            } catch (e) {
                errorEl.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';
            }
        }
        
        function showMainUI() {
            document.getElementById('authContainer').classList.add('hidden');
            document.getElementById('mainContainer').classList.remove('hidden');
            document.getElementById('currentUser').textContent = currentUser;
            initOS();
        }
        
        function logout() {
            localStorage.removeItem('factoryAuth');
            authToken = null;
            currentUser = null;
            keys = [];
            document.getElementById('authContainer').classList.remove('hidden');
            document.getElementById('mainContainer').classList.add('hidden');
            document.getElementById('authUsername').value = '';
            document.getElementById('authPassword').value = '';
        }
        
        function initOS() {
            const ua = navigator.userAgent;
            let detectedOS = 'Linux';
            if (/Windows/.test(ua)) detectedOS = 'Windows';
            else if (/Mac/.test(ua)) detectedOS = 'macOS';
            document.getElementById('osName').textContent = detectedOS;
            
            if (detectedOS === 'Windows') showOS('windows');
            else if (detectedOS === 'macOS') showOS('mac');
            else showOS('linux');
        }
        
        function showOS(os) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[onclick="showOS('${os}')"]`).classList.add('active');
            document.getElementById('cmdWindows').style.display = os === 'windows' ? 'block' : 'none';
            document.getElementById('cmdLinux').style.display = os === 'linux' ? 'block' : 'none';
            document.getElementById('cmdMac').style.display = os === 'mac' ? 'block' : 'none';
        }
        
        function updateCmds(key) {
            const k = key || 'YOUR_API_KEY';
            document.getElementById('cmdWinTemp').textContent = `set FACTORY_API_KEY=${k}`;
            document.getElementById('cmdWinPerm').textContent = `setx FACTORY_API_KEY "${k}"`;
            document.getElementById('cmdLinuxTemp').textContent = `export FACTORY_API_KEY="${k}"`;
            document.getElementById('cmdLinuxBash').textContent = `echo 'export FACTORY_API_KEY="${k}"' >> ~/.bashrc && source ~/.bashrc`;
            document.getElementById('cmdMacTemp').textContent = `export FACTORY_API_KEY="${k}"`;
            document.getElementById('cmdMacZsh').textContent = `echo 'export FACTORY_API_KEY="${k}"' >> ~/.zshrc && source ~/.zshrc`;
            document.getElementById('currentKey').textContent = key ? key.substring(0, 30) + (key.length > 30 ? '...' : '') : '-';
        }
        
        function copyCmd(id) {
            const text = document.getElementById(id).textContent;
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.querySelector(`#${id}`).nextElementSibling;
                btn.textContent = 'å·²å¤åˆ¶';
                setTimeout(() => btn.textContent = 'å¤åˆ¶', 1500);
            });
        }
        
        async function loadKeys() {
            try {
                const response = await fetch('/api/keys', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                
                if (data.error) {
                    if (response.status === 401) logout();
                    return;
                }
                
                keys = data.keys.map(k => ({
                    id: k.id,
                    key: k.api_key,
                    usage: k.usage_data ? JSON.parse(k.usage_data) : null,
                    error: k.error,
                    note: k.note || ''
                }));
                renderKeys();
            } catch (e) {
                console.error('åŠ è½½å¤±è´¥', e);
            }
        }
        
        function getKeyStatus(k) {
            if (k.error) return 'error';
            if (!k.usage) return 'pending';
            const now = Date.now();
            if (k.usage.endDate < now) return 'error';
            const remaining = (k.usage.standard?.totalAllowance || 0) - (k.usage.standard?.orgTotalTokensUsed || 0);
            if (remaining < 1000000) return 'low';
            return 'normal';
        }
        
        function formatTokens(n) {
            if (!n && n !== 0) return '-';
            if (n >= 1e9) return (n / 1e9).toFixed(1) + 'B';
            if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
            if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
            return n.toString();
        }
        
        function renderKeys() {
            let normal = 0, low = 0, error = 0;
            
            keys.forEach(k => {
                const status = getKeyStatus(k);
                if (status === 'normal') normal++;
                else if (status === 'low') low++;
                else if (status === 'error') error++;
            });
            
            document.getElementById('totalKeys').textContent = keys.length;
            document.getElementById('normalKeys').textContent = normal;
            document.getElementById('lowKeys').textContent = low;
            document.getElementById('errorKeys').textContent = error;
            
            if (keys.length === 0) {
                document.getElementById('keyList').innerHTML = '<div class="empty">æš‚æ— å¯†é’¥ï¼Œè¯·æ·»åŠ ä½ çš„ç¬¬ä¸€ä¸ª API Key</div>';
                updateCmds(null);
                return;
            }
            
            document.getElementById('keyList').innerHTML = keys.map((k, i) => {
                const status = getKeyStatus(k);
                const statusText = { 'normal': 'æ­£å¸¸', 'low': 'ä½ä½™é¢', 'error': k.error || 'å¼‚å¸¸', 'pending': 'åŠ è½½ä¸­...' }[status];
                
                let infoHtml = '';
                if (k.usage) {
                    const used = k.usage.standard?.orgTotalTokensUsed || 0;
                    const total = k.usage.standard?.totalAllowance || 0;
                    const remaining = total - used;
                    const expire = new Date(k.usage.endDate);
                    const days = Math.ceil((expire - Date.now()) / (1000 * 60 * 60 * 24));
                    infoHtml = `
                        <span>å·²ç”¨: ${formatTokens(used)} / ${formatTokens(total)}</span>
                        <span>å‰©ä½™: ${formatTokens(remaining)}</span>
                        <span>è¿‡æœŸ: ${expire.toLocaleDateString('zh-CN')} (${days > 0 ? days + 'å¤©' : 'å·²è¿‡æœŸ'})</span>
                    `;
                } else if (k.error) {
                    infoHtml = `<span style="color:#f87171">${k.error}</span>`;
                } else {
                    infoHtml = '<span>æ­£åœ¨è·å–ä¿¡æ¯...</span>';
                }
                
                const noteHtml = k.note ? `<div class="key-note">${k.note}</div>` : '';
                
                return `<div class="key-card ${status} ${i === selectedIndex ? 'selected' : ''}" 
                    draggable="true" data-index="${i}"
                    onclick="selectKey(${i})"
                    ondragstart="handleDragStart(event, ${i})"
                    ondragend="handleDragEnd(event)"
                    ondragover="handleDragOver(event)"
                    ondragleave="handleDragLeave(event)"
                    ondrop="handleDrop(event, ${i})">
                    <div class="key-header">
                        <span class="key-value">${k.key.substring(0, 32)}${k.key.length > 32 ? '...' : ''}</span>
                        <span class="key-status ${status}">${statusText}</span>
                    </div>
                    ${noteHtml}
                    <div class="key-info">${infoHtml}</div>
                    <div class="key-actions">
                        <button class="btn-copy" onclick="event.stopPropagation(); copyKey(${i})">å¤åˆ¶</button>
                        <button class="btn-refresh" onclick="event.stopPropagation(); refreshKey(${i})">åˆ·æ–°</button>
                        <button class="btn-note" onclick="event.stopPropagation(); editNote(${i})">å¤‡æ³¨</button>
                        <button class="btn-delete" onclick="event.stopPropagation(); deleteKey(${i})">åˆ é™¤</button>
                    </div>
                </div>`;
            }).join('');
        }
        
        function selectKey(index) {
            selectedIndex = index;
            updateCmds(keys[index].key);
            renderKeys();
        }
        
        async function addKey() {
            const keyInput = document.getElementById('keyValue');
            const key = keyInput.value.trim();
            if (!key) { alert('è¯·è¾“å…¥ API Key'); return; }
            
            const btn = document.getElementById('addKeyBtn');
            btn.disabled = true;
            btn.textContent = 'æ·»åŠ ä¸­...';
            
            try {
                const response = await fetch('/api/keys', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                    body: JSON.stringify({ apiKey: key })
                });
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                keys.unshift({
                    id: data.id,
                    key: data.apiKey,
                    usage: data.usageData,
                    error: data.error
                });
                keyInput.value = '';
                renderKeys();
            } catch (e) {
                alert('æ·»åŠ å¤±è´¥');
            } finally {
                btn.disabled = false;
                btn.textContent = 'æ·»åŠ ';
            }
        }
        
        async function refreshKey(index) {
            const k = keys[index];
            k.usage = null;
            k.error = null;
            renderKeys();
            
            try {
                const response = await fetch('/api/refresh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                    body: JSON.stringify({ keyId: k.id })
                });
                const data = await response.json();
                
                keys[index].usage = data.usageData;
                keys[index].error = data.error;
                renderKeys();
            } catch (e) {
                keys[index].error = 'åˆ·æ–°å¤±è´¥';
                renderKeys();
            }
        }
        
        async function refreshAll() {
            for (let i = 0; i < keys.length; i++) {
                await refreshKey(i);
            }
        }
        
        async function deleteKey(index) {
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤å¯†é’¥ï¼Ÿ')) return;
            
            try {
                await fetch(`/api/keys?id=${keys[index].id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                keys.splice(index, 1);
                if (selectedIndex === index) { selectedIndex = -1; updateCmds(null); }
                else if (selectedIndex > index) selectedIndex--;
                renderKeys();
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥');
            }
        }
        
        async function clearAll() {
            if (!confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰å¯†é’¥ï¼Ÿ')) return;
            
            for (const k of keys) {
                await fetch(`/api/keys?id=${k.id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
            }
            keys = [];
            selectedIndex = -1;
            renderKeys();
            updateCmds(null);
        }
        
        // å¤åˆ¶å¯†é’¥
        function copyKey(index) {
            const key = keys[index].key;
            navigator.clipboard.writeText(key).then(() => {
                const cards = document.querySelectorAll('.key-card');
                const btn = cards[index].querySelector('.btn-copy');
                btn.textContent = 'å·²å¤åˆ¶';
                setTimeout(() => btn.textContent = 'å¤åˆ¶', 1500);
            });
        }
        
        // æ‹–æ‹½åŠŸèƒ½
        let draggedIndex = null;
        
        function handleDragStart(e, index) {
            draggedIndex = index;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
        
        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.key-card').forEach(card => card.classList.remove('drag-over'));
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            e.currentTarget.classList.add('drag-over');
        }
        
        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }
        
        async function handleDrop(e, targetIndex) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            if (draggedIndex === null || draggedIndex === targetIndex) return;
            
            // é‡æ–°æ’åº
            const draggedKey = keys[draggedIndex];
            keys.splice(draggedIndex, 1);
            keys.splice(targetIndex, 0, draggedKey);
            
            // æ›´æ–°é€‰ä¸­ç´¢å¼•
            if (selectedIndex === draggedIndex) {
                selectedIndex = targetIndex;
            } else if (selectedIndex > draggedIndex && selectedIndex <= targetIndex) {
                selectedIndex--;
            } else if (selectedIndex < draggedIndex && selectedIndex >= targetIndex) {
                selectedIndex++;
            }
            
            draggedIndex = null;
            renderKeys();
            
            // ä¿å­˜é¡ºåºåˆ°æœåŠ¡å™¨
            await saveOrder();
        }
        
        async function saveOrder() {
            try {
                const order = keys.map(k => k.id);
                await fetch('/api/keys/order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                    body: JSON.stringify({ order })
                });
            } catch (e) {
                console.error('ä¿å­˜é¡ºåºå¤±è´¥', e);
            }
        }
        
        // ç¼–è¾‘å¤‡æ³¨
        async function editNote(index) {
            const k = keys[index];
            const note = prompt('è¾“å…¥å¤‡æ³¨ (ç•™ç©ºåˆ™æ¸…é™¤):', k.note || '');
            if (note === null) return; // å–æ¶ˆ
            
            try {
                const response = await fetch('/api/keys', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                    body: JSON.stringify({ keyId: k.id, note: note })
                });
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                keys[index].note = note;
                renderKeys();
            } catch (e) {
                alert('ä¿å­˜å¤‡æ³¨å¤±è´¥');
            }
        }
        
        // æŠ˜å ç¯å¢ƒå˜é‡æŒ‡ä»¤
        function toggleEnvSection() {
            const section = document.getElementById('envSection');
            const header = document.querySelector('.collapsible');
            section.classList.toggle('collapsed');
            header.classList.toggle('collapsed');
        }
        
        // è‡ªåŠ¨åˆ·æ–°
        let autoRefreshTimer = null;
        document.getElementById('autoRefresh')?.addEventListener('change', (e) => {
            if (e.target.checked) {
                refreshAll();
                autoRefreshTimer = setInterval(refreshAll, 60000);
            } else {
                clearInterval(autoRefreshTimer);
            }
        });
    </script>
</body>
</html>
