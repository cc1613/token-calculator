<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factory Key ç®¡ç†</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f0f0f;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 900px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        h1 { font-size: 20px; font-weight: 500; }
        .back { color: #667eea; text-decoration: none; font-size: 14px; }
        
        .section { background: #1a1a1a; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .section-title { font-size: 14px; color: #888; margin-bottom: 12px; }
        
        .os-detect { color: #888; font-size: 14px; margin-bottom: 8px; }
        .os-detect span { color: #667eea; }
        .current-key { font-family: monospace; font-size: 16px; color: #fff; }
        
        .tabs { display: flex; gap: 0; margin: 16px 0 12px; }
        .tab {
            padding: 8px 16px;
            background: #2a2a2a;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 13px;
        }
        .tab:first-child { border-radius: 6px 0 0 6px; }
        .tab:last-child { border-radius: 0 6px 6px 0; }
        .tab.active { background: #667eea; color: white; }
        
        .cmd-block { margin-bottom: 12px; }
        .cmd-label { font-size: 12px; color: #666; margin-bottom: 6px; }
        .cmd-box {
            background: #0a0a0a;
            border-radius: 8px;
            padding: 12px 16px;
            font-family: monospace;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .cmd-box code { color: #4ade80; word-break: break-all; }
        .copy-btn {
            background: #333;
            border: none;
            color: #888;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
            margin-left: 12px;
        }
        .copy-btn:hover { background: #444; color: #fff; }
        
        .add-form { display: flex; gap: 10px; flex-wrap: wrap; }
        .add-form input {
            flex: 1;
            min-width: 200px;
            padding: 10px 14px;
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
        }
        .add-form input:focus { outline: none; border-color: #667eea; }
        .add-form button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .stats { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
        .stat { background: #1a1a1a; border-radius: 8px; padding: 12px 20px; text-align: center; min-width: 100px; }
        .stat-value { font-size: 24px; font-weight: 600; }
        .stat-value.normal { color: #4ade80; }
        .stat-value.low { color: #fbbf24; }
        .stat-value.error { color: #f87171; }
        .stat-label { font-size: 12px; color: #666; margin-top: 4px; }
        
        .key-list { display: flex; flex-direction: column; gap: 10px; }
        .key-card {
            background: #1a1a1a;
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 14px 18px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .key-card:hover { border-color: #333; }
        .key-card.selected { border-color: #667eea; background: #1e1e2e; }
        .key-card.error { border-color: #f87171; }
        .key-card.low { border-color: #fbbf24; }
        .key-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .key-value { font-family: monospace; font-size: 14px; color: #fff; }
        .key-status { font-size: 12px; padding: 2px 8px; border-radius: 4px; }
        .key-status.normal { background: #166534; color: #4ade80; }
        .key-status.low { background: #854d0e; color: #fbbf24; }
        .key-status.error { background: #991b1b; color: #f87171; }
        .key-info { display: flex; gap: 20px; font-size: 13px; color: #888; }
        .key-actions { display: flex; gap: 8px; margin-top: 10px; }
        .key-actions button {
            padding: 4px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .btn-delete { background: #7f1d1d; color: #f87171; }
        
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 10px; }
        .toolbar-left { font-size: 14px; color: #888; }
        .toolbar-right { display: flex; gap: 10px; }
        .toolbar button {
            padding: 6px 14px;
            background: #2a2a2a;
            border: none;
            color: #888;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }
        .toolbar button:hover { background: #333; color: #fff; }
        .toolbar button.danger:hover { background: #7f1d1d; color: #f87171; }
        
        .empty { text-align: center; padding: 40px; color: #666; }
        .auto-refresh { display: flex; align-items: center; gap: 8px; }
        .auto-refresh input { accent-color: #667eea; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”‘ Factory Key ç®¡ç†</h1>
            <a href="index.html" class="back">â† è¿”å›å·¥å…·ç®±</a>
        </div>
        
        <div class="section">
            <div class="os-detect">æ£€æµ‹åˆ°: <span id="osName">-</span></div>
            <div class="current-key">å½“å‰: <code id="currentKey">-</code></div>
            
            <h3 style="font-size:14px; margin:16px 0 8px;">ç¯å¢ƒå˜é‡è®¾ç½®æŒ‡ä»¤</h3>
            <div class="tabs">
                <button class="tab active" onclick="showOS('windows')">Windows</button>
                <button class="tab" onclick="showOS('linux')">Linux</button>
                <button class="tab" onclick="showOS('mac')">macOS</button>
            </div>
            
            <div id="cmdWindows">
                <div class="cmd-block">
                    <div class="cmd-label">ä¸´æ—¶è®¾ç½® (å½“å‰ç»ˆç«¯æœ‰æ•ˆ)</div>
                    <div class="cmd-box"><code id="cmdWinTemp">set FACTORY_API_KEY=YOUR_API_KEY</code><button class="copy-btn" onclick="copyCmd('cmdWinTemp')">å¤åˆ¶</button></div>
                </div>
                <div class="cmd-block">
                    <div class="cmd-label">æ°¸ä¹…è®¾ç½® (éœ€ç®¡ç†å‘˜æƒé™)</div>
                    <div class="cmd-box"><code id="cmdWinPerm">setx FACTORY_API_KEY "YOUR_API_KEY"</code><button class="copy-btn" onclick="copyCmd('cmdWinPerm')">å¤åˆ¶</button></div>
                </div>
            </div>
            <div id="cmdLinux" style="display:none;">
                <div class="cmd-block">
                    <div class="cmd-label">ä¸´æ—¶è®¾ç½®</div>
                    <div class="cmd-box"><code id="cmdLinuxTemp">export FACTORY_API_KEY="YOUR_API_KEY"</code><button class="copy-btn" onclick="copyCmd('cmdLinuxTemp')">å¤åˆ¶</button></div>
                </div>
                <div class="cmd-block">
                    <div class="cmd-label">Bash æ°¸ä¹…è®¾ç½® (~/.bashrc)</div>
                    <div class="cmd-box"><code id="cmdLinuxBash">echo 'export FACTORY_API_KEY="YOUR_API_KEY"' >> ~/.bashrc && source ~/.bashrc</code><button class="copy-btn" onclick="copyCmd('cmdLinuxBash')">å¤åˆ¶</button></div>
                </div>
            </div>
            <div id="cmdMac" style="display:none;">
                <div class="cmd-block">
                    <div class="cmd-label">ä¸´æ—¶è®¾ç½®</div>
                    <div class="cmd-box"><code id="cmdMacTemp">export FACTORY_API_KEY="YOUR_API_KEY"</code><button class="copy-btn" onclick="copyCmd('cmdMacTemp')">å¤åˆ¶</button></div>
                </div>
                <div class="cmd-block">
                    <div class="cmd-label">Zsh æ°¸ä¹…è®¾ç½® (~/.zshrc)</div>
                    <div class="cmd-box"><code id="cmdMacZsh">echo 'export FACTORY_API_KEY="YOUR_API_KEY"' >> ~/.zshrc && source ~/.zshrc</code><button class="copy-btn" onclick="copyCmd('cmdMacZsh')">å¤åˆ¶</button></div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">æ·»åŠ å¯†é’¥</div>
            <div class="add-form">
                <input type="text" id="keyValue" placeholder="è¾“å…¥ Factory API Key">
                <button onclick="addKey()">æ·»åŠ </button>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat"><div class="stat-value" id="totalKeys">0</div><div class="stat-label">æ€»è®¡</div></div>
            <div class="stat"><div class="stat-value normal" id="normalKeys">0</div><div class="stat-label">æ­£å¸¸</div></div>
            <div class="stat"><div class="stat-value low" id="lowKeys">0</div><div class="stat-label">ä½ä½™é¢</div></div>
            <div class="stat"><div class="stat-value error" id="errorKeys">0</div><div class="stat-label">å·²è¿‡æœŸ</div></div>
        </div>
        
        <div class="toolbar">
            <div class="toolbar-left">å¯†é’¥åˆ—è¡¨ <span style="color:#666">ç‚¹å‡»å¡ç‰‡é€‰ä¸­å¯†é’¥ï¼Œä¸Šæ–¹å‘½ä»¤è‡ªåŠ¨æ›´æ–°</span></div>
            <div class="toolbar-right">
                <label class="auto-refresh"><input type="checkbox" id="autoRefresh"> è‡ªåŠ¨åˆ·æ–°</label>
                <button onclick="clearAll()" class="danger">æ¸…ç©ºå…¨éƒ¨</button>
            </div>
        </div>
        
        <div class="key-list" id="keyList">
            <div class="empty">æš‚æ— å¯†é’¥ï¼Œè¯·æ·»åŠ ä½ çš„ç¬¬ä¸€ä¸ª API Key</div>
        </div>
    </div>

    <script>
        let keys = JSON.parse(localStorage.getItem('factoryKeys') || '[]');
        let selectedIndex = -1;
        
        // æ£€æµ‹æ“ä½œç³»ç»Ÿ
        const ua = navigator.userAgent;
        let detectedOS = 'Linux';
        if (/Windows/.test(ua)) detectedOS = 'Windows';
        else if (/Mac/.test(ua)) detectedOS = 'macOS';
        document.getElementById('osName').textContent = detectedOS;
        
        // æ ¹æ®ç³»ç»Ÿé»˜è®¤æ˜¾ç¤ºå¯¹åº” tab
        if (detectedOS === 'Windows') showOS('windows');
        else if (detectedOS === 'macOS') showOS('mac');
        else showOS('linux');
        
        function showOS(os) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[onclick="showOS('${os}')"]`).classList.add('active');
            document.getElementById('cmdWindows').style.display = os === 'windows' ? 'block' : 'none';
            document.getElementById('cmdLinux').style.display = os === 'linux' ? 'block' : 'none';
            document.getElementById('cmdMac').style.display = os === 'mac' ? 'block' : 'none';
        }
        
        function updateCmds(key) {
            const k = key || 'YOUR_API_KEY';
            document.getElementById('cmdWinTemp').textContent = `set FACTORY_API_KEY=${k}`;
            document.getElementById('cmdWinPerm').textContent = `setx FACTORY_API_KEY "${k}"`;
            document.getElementById('cmdLinuxTemp').textContent = `export FACTORY_API_KEY="${k}"`;
            document.getElementById('cmdLinuxBash').textContent = `echo 'export FACTORY_API_KEY="${k}"' >> ~/.bashrc && source ~/.bashrc`;
            document.getElementById('cmdMacTemp').textContent = `export FACTORY_API_KEY="${k}"`;
            document.getElementById('cmdMacZsh').textContent = `echo 'export FACTORY_API_KEY="${k}"' >> ~/.zshrc && source ~/.zshrc`;
            document.getElementById('currentKey').textContent = key ? key.substring(0, 30) + (key.length > 30 ? '...' : '') : '-';
        }
        
        function copyCmd(id) {
            const text = document.getElementById(id).textContent;
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.querySelector(`#${id}`).nextElementSibling;
                btn.textContent = 'å·²å¤åˆ¶';
                setTimeout(() => btn.textContent = 'å¤åˆ¶', 1500);
            });
        }
        
        function saveKeys() {
            localStorage.setItem('factoryKeys', JSON.stringify(keys));
        }
        
        function getKeyStatus(k) {
            if (k.error) return 'error';
            if (!k.usage) return 'pending';
            const now = Date.now();
            if (k.usage.endDate < now) return 'error';
            const remaining = k.usage.totalAllowance - k.usage.used;
            if (remaining < 1000000) return 'low'; // < 1M tokens
            return 'normal';
        }
        
        function formatTokens(n) {
            if (!n && n !== 0) return '-';
            if (n >= 1e9) return (n / 1e9).toFixed(1) + 'B';
            if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
            if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
            return n.toString();
        }
        
        function renderKeys() {
            let normal = 0, low = 0, error = 0;
            
            keys.forEach(k => {
                const status = getKeyStatus(k);
                if (status === 'normal') normal++;
                else if (status === 'low') low++;
                else if (status === 'error') error++;
            });
            
            document.getElementById('totalKeys').textContent = keys.length;
            document.getElementById('normalKeys').textContent = normal;
            document.getElementById('lowKeys').textContent = low;
            document.getElementById('errorKeys').textContent = error;
            
            if (keys.length === 0) {
                document.getElementById('keyList').innerHTML = '<div class="empty">æš‚æ— å¯†é’¥ï¼Œè¯·æ·»åŠ ä½ çš„ç¬¬ä¸€ä¸ª API Key</div>';
                updateCmds(null);
                return;
            }
            
            document.getElementById('keyList').innerHTML = keys.map((k, i) => {
                const status = getKeyStatus(k);
                const statusText = {
                    'normal': 'æ­£å¸¸',
                    'low': 'ä½ä½™é¢', 
                    'error': k.error || 'å·²è¿‡æœŸ',
                    'pending': 'åŠ è½½ä¸­...'
                }[status];
                
                let infoHtml = '';
                if (k.usage) {
                    const used = k.usage.used || 0;
                    const total = k.usage.totalAllowance || 0;
                    const remaining = total - used;
                    const expire = new Date(k.usage.endDate);
                    const days = Math.ceil((expire - Date.now()) / (1000 * 60 * 60 * 24));
                    infoHtml = `
                        <span>å·²ç”¨: ${formatTokens(used)} / ${formatTokens(total)}</span>
                        <span>å‰©ä½™: ${formatTokens(remaining)}</span>
                        <span>è¿‡æœŸ: ${expire.toLocaleDateString('zh-CN')} (${days > 0 ? days + 'å¤©' : 'å·²è¿‡æœŸ'})</span>
                    `;
                } else if (k.error) {
                    infoHtml = `<span style="color:#f87171">${k.error}</span>`;
                } else {
                    infoHtml = '<span>æ­£åœ¨è·å–ä¿¡æ¯...</span>';
                }
                
                return `<div class="key-card ${status} ${i === selectedIndex ? 'selected' : ''}" onclick="selectKey(${i})">
                    <div class="key-header">
                        <span class="key-value">${k.key.substring(0, 40)}${k.key.length > 40 ? '...' : ''}</span>
                        <span class="key-status ${status}">${statusText}</span>
                    </div>
                    <div class="key-info">${infoHtml}</div>
                    <div class="key-actions">
                        <button class="btn-delete" onclick="event.stopPropagation(); deleteKey(${i})" style="margin-right:8px">åˆ é™¤</button>
                        <button onclick="event.stopPropagation(); refreshKey(${i})" style="background:#1e3a5f;color:#60a5fa">åˆ·æ–°</button>
                    </div>
                </div>`;
            }).join('');
        }
        
        function selectKey(index) {
            selectedIndex = index;
            updateCmds(keys[index].key);
            renderKeys();
        }
        
        async function fetchKeyInfo(index) {
            const k = keys[index];
            try {
                const response = await fetch(`/api/check?key=${encodeURIComponent(k.key)}`);
                const data = await response.json();
                
                if (data.error) {
                    keys[index].error = data.error;
                    keys[index].usage = null;
                } else if (data.usage) {
                    keys[index].error = null;
                    keys[index].usage = {
                        startDate: data.usage.startDate,
                        endDate: data.usage.endDate,
                        used: data.usage.standard?.orgTotalTokensUsed || 0,
                        totalAllowance: data.usage.standard?.totalAllowance || 0,
                        usedRatio: data.usage.standard?.usedRatio || 0
                    };
                }
            } catch (e) {
                keys[index].error = 'è·å–å¤±è´¥';
            }
            saveKeys();
            renderKeys();
        }
        
        async function refreshKey(index) {
            keys[index].error = null;
            keys[index].usage = null;
            renderKeys();
            await fetchKeyInfo(index);
        }
        
        async function refreshAll() {
            for (let i = 0; i < keys.length; i++) {
                await fetchKeyInfo(i);
            }
        }
        
        async function addKey() {
            const key = document.getElementById('keyValue').value.trim();
            if (!key) { alert('è¯·è¾“å…¥ API Key'); return; }
            if (keys.some(k => k.key === key)) { alert('æ­¤ Key å·²å­˜åœ¨'); return; }
            
            const index = keys.length;
            keys.push({ key, usage: null, error: null });
            saveKeys();
            renderKeys();
            document.getElementById('keyValue').value = '';
            
            await fetchKeyInfo(index);
        }
        
        function deleteKey(index) {
            if (confirm('ç¡®å®šåˆ é™¤æ­¤å¯†é’¥ï¼Ÿ')) {
                keys.splice(index, 1);
                if (selectedIndex === index) { selectedIndex = -1; updateCmds(null); }
                else if (selectedIndex > index) selectedIndex--;
                saveKeys();
                renderKeys();
            }
        }
        
        function clearAll() {
            if (confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰å¯†é’¥ï¼Ÿ')) {
                keys = [];
                selectedIndex = -1;
                saveKeys();
                renderKeys();
                updateCmds(null);
            }
        }
        
        renderKeys();
        
        // è‡ªåŠ¨åˆ·æ–°
        let autoRefreshTimer = null;
        document.getElementById('autoRefresh').addEventListener('change', (e) => {
            if (e.target.checked) {
                refreshAll();
                autoRefreshTimer = setInterval(refreshAll, 60000);
            } else {
                clearInterval(autoRefreshTimer);
            }
        });
    </script>
</body>
</html>
